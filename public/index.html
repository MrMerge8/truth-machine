<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liar Liar - The Truth Machine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --black: #000000;
      --white: #ffffff;
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-400: #a3a3a3;
      --gray-600: #525252;
      --gray-800: #1a1a1a;
      --truth: #10b981;
      --lie: #ef4444;
      --accent: #8b5cf6;
      --gold: #fbbf24;
      --silver: #9ca3af;
      --bronze: #d97706;
    }

    body {
      font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-100);
      color: var(--black);
      min-height: 100vh;
      line-height: 1.4;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Content Mode Toggle */
    .content-toggle {
      display: flex;
      justify-content: center;
      gap: 4px;
      padding: 8px 0;
      margin-bottom: 8px;
    }

    .content-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-400);
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 24px;
    }

    .content-btn:hover {
      color: var(--gray-600);
    }

    .content-btn.active {
      background: var(--black);
      color: var(--white);
    }

    .content-btn.active.family {
      background: var(--accent);
    }

    /* Header */
    header {
      text-align: center;
      padding: 20px 0 28px;
    }

    .logo {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--gray-400);
    }

    .title {
      font-size: clamp(2.2rem, 11vw, 3rem);
      font-weight: 700;
      letter-spacing: -0.04em;
      margin-top: 8px;
      color: var(--black);
    }

    .subtitle {
      font-size: 14px;
      color: var(--gray-600);
      margin-top: 8px;
    }

    /* Nav Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--gray-200);
      padding: 4px;
      border-radius: 12px;
    }

    .nav-tab {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .nav-tab:hover {
      color: var(--black);
    }

    .nav-tab.active {
      background: var(--white);
      color: var(--black);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .card-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gray-400);
      margin-bottom: 16px;
    }

    /* Challenge Card */
    .challenge-card {
      display: none;
      background: var(--black);
      color: var(--white);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 16px;
      min-height: 180px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      flex-direction: column;
    }

    .challenge-card.visible {
      display: flex;
    }

    .challenge-card.family-mode {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    }

    .challenge-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }

    .challenge-text {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.3;
      letter-spacing: -0.02em;
      flex: 1;
    }

    .challenge-actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .shuffle-btn {
      flex: 1;
      padding: 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 10px;
      color: var(--white);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .shuffle-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .use-custom-btn {
      padding: 14px 20px;
      background: var(--white);
      border: none;
      border-radius: 10px;
      color: var(--black);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .use-custom-btn:hover {
      transform: scale(1.02);
    }

    /* Input styles */
    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 8px;
      display: block;
    }

    .text-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      font-family: inherit;
      font-size: 15px;
      transition: border-color 0.15s ease;
      background: var(--white);
    }

    .text-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .text-input::placeholder {
      color: var(--gray-400);
    }

    /* Player List */
    .player-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }

    .player-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--gray-100);
      border-radius: 24px;
      font-size: 14px;
      font-weight: 600;
    }

    .player-chip .remove {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-400);
      color: var(--white);
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .player-chip .remove:hover {
      background: var(--lie);
    }

    /* Buttons */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 16px 24px;
      background: var(--black);
      border: none;
      border-radius: 12px;
      color: var(--white);
      font-family: inherit;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:disabled {
      background: var(--gray-200);
      color: var(--gray-400);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--black);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--gray-200);
      box-shadow: none;
      transform: none;
    }

    .btn-small {
      padding: 12px 20px;
      font-size: 14px;
    }

    /* Record Button */
    .record-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0;
    }

    .current-player-badge {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .current-player-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
    }

    .record-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      background: var(--black);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .record-btn:hover {
      transform: scale(1.05);
    }

    .record-btn.recording {
      background: var(--lie);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    .record-btn svg {
      width: 32px;
      height: 32px;
      color: white;
    }

    .record-hint {
      margin-top: 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
    }

    .record-hint.recording {
      color: var(--lie);
      font-weight: 600;
    }

    .timer {
      font-size: 42px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--black);
      margin-top: 16px;
      display: none;
    }

    .timer.visible {
      display: block;
    }

    /* Progress indicator */
    .progress-bar {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gray-200);
    }

    .progress-dot.done {
      background: var(--truth);
    }

    .progress-dot.current {
      background: var(--accent);
      animation: pulseDot 1s ease-in-out infinite;
    }

    @keyframes pulseDot {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Leaderboard */
    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .leaderboard-rank {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-200);
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
    }

    .leaderboard-rank.gold {
      background: var(--gold);
      color: var(--white);
    }

    .leaderboard-rank.silver {
      background: var(--silver);
      color: var(--white);
    }

    .leaderboard-rank.bronze {
      background: var(--bronze);
      color: var(--white);
    }

    .leaderboard-info {
      flex: 1;
    }

    .leaderboard-name {
      font-weight: 700;
      font-size: 15px;
    }

    .leaderboard-stats {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 2px;
    }

    .leaderboard-score {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    /* Score cards */
    .score-card {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .score-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .score-card-name {
      font-weight: 700;
      font-size: 18px;
    }

    .score-card-total {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
    }

    .score-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .score-item {
      text-align: center;
      padding: 12px 4px;
      background: var(--white);
      border-radius: 10px;
      cursor: help;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .score-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .score-item-label {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .score-item-value {
      font-size: 16px;
      font-weight: 700;
    }

    .score-feedback {
      font-size: 14px;
      color: var(--gray-600);
      line-height: 1.6;
      padding: 12px;
      background: var(--white);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .score-tip {
      font-size: 13px;
      color: var(--accent);
      padding: 10px 12px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 8px;
    }

    @media (max-width: 400px) {
      .score-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Results screen */
    .winner-banner {
      text-align: center;
      padding: 32px 24px;
      background: linear-gradient(135deg, var(--gold) 0%, #f59e0b 100%);
      border-radius: 16px;
      margin-bottom: 16px;
    }

    .winner-crown {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .winner-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.8);
    }

    .winner-name {
      font-size: 32px;
      font-weight: 700;
      color: var(--white);
      margin-top: 8px;
    }

    .winner-score {
      font-size: 18px;
      color: rgba(255,255,255,0.9);
      margin-top: 4px;
    }

    /* Section visibility */
    .section {
      display: none;
    }

    .section.visible {
      display: block;
    }

    /* Analyzing overlay */
    .analyzing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 100;
    }

    .analyzing-overlay.visible {
      display: flex;
    }

    .analyzing-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .analyzing-text {
      font-size: 18px;
      font-weight: 700;
      margin-top: 20px;
    }

    .analyzing-subtext {
      font-size: 14px;
      color: var(--gray-600);
      margin-top: 6px;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 24px 16px;
      margin-top: auto;
    }

    .footer-text {
      font-size: 11px;
      color: var(--gray-400);
      letter-spacing: 0.05em;
    }

    /* Dark Mode */
    body.dark-mode {
      background: #0a0a0a;
      color: var(--white);
    }

    body.dark-mode .card {
      background: var(--gray-800);
    }

    body.dark-mode .nav-tabs {
      background: #1a1a1a;
    }

    body.dark-mode .nav-tab {
      color: var(--gray-400);
    }

    body.dark-mode .nav-tab.active {
      background: #2a2a2a;
      color: var(--white);
    }

    body.dark-mode .title {
      color: var(--white);
    }

    body.dark-mode .text-input {
      background: #1a1a1a;
      border-color: #333;
      color: var(--white);
    }

    body.dark-mode .text-input:focus {
      border-color: var(--accent);
    }

    body.dark-mode .player-chip {
      background: #2a2a2a;
      color: var(--white);
    }

    body.dark-mode .btn {
      background: var(--white);
      color: var(--black);
    }

    body.dark-mode .btn-secondary {
      background: #2a2a2a;
      color: var(--white);
    }

    body.dark-mode .record-btn {
      background: var(--white);
    }

    body.dark-mode .record-btn svg {
      color: var(--black);
    }

    body.dark-mode .record-btn.recording {
      background: var(--lie);
    }

    body.dark-mode .record-btn.recording svg {
      color: var(--white);
    }

    body.dark-mode .timer {
      color: var(--white);
    }

    body.dark-mode .leaderboard-item {
      background: #1a1a1a;
    }

    body.dark-mode .leaderboard-name {
      color: var(--white);
    }

    body.dark-mode .score-card {
      background: #1a1a1a;
    }

    body.dark-mode .score-item {
      background: #2a2a2a;
    }

    body.dark-mode .score-item-value {
      color: var(--white);
    }

    body.dark-mode .score-feedback {
      background: #2a2a2a;
      color: #ccc;
    }

    body.dark-mode .analyzing-overlay {
      background: rgba(10,10,10,0.95);
    }

    body.dark-mode .analyzing-spinner {
      border-color: #333;
      border-top-color: var(--accent);
    }

    body.dark-mode .analyzing-text {
      color: var(--white);
    }

    body.dark-mode .content-btn {
      color: #666;
    }

    body.dark-mode .content-btn:hover {
      color: #999;
    }

    body.dark-mode .content-btn.active {
      background: var(--white);
      color: var(--black);
    }

    body.dark-mode .content-btn.active.family {
      background: var(--accent);
      color: var(--white);
    }

    body.dark-mode .current-player-name {
      color: var(--white);
    }

    body.dark-mode .progress-dot {
      background: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Content Mode Toggle -->
    <div class="content-toggle">
      <button class="content-btn family active" data-content="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</button>
      <button class="content-btn" data-content="dark">üíÄ Unhinged</button>
    </div>

    <header>
      <div class="logo">Truth Machine</div>
      <h1 class="title">Liar Liar</h1>
      <p class="subtitle">Fool the AI. Become the ultimate deceiver.</p>
    </header>

    <!-- Navigation -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="play">üéÆ Play</button>
      <button class="nav-tab" data-tab="leaderboard">üèÜ Leaderboard</button>
    </div>

    <!-- PLAY SECTION -->
    <div class="section visible" id="playSection">
      
      <!-- Setup Phase -->
      <div class="section visible" id="setupPhase">
        <div class="card">
          <div class="card-title">Step 1: Add Players</div>
          
          <div class="input-group">
            <input type="text" class="text-input" id="playerInput" placeholder="Enter player name...">
          </div>
          
          <button class="btn btn-secondary btn-small" id="addPlayerBtn">+ Add Player</button>
          
          <div class="player-chips" id="playerChips"></div>
        </div>

        <div class="card">
          <div class="card-title">Step 2: Choose a Challenge</div>
          
          <div class="input-group">
            <input type="text" class="text-input" id="customQuestion" placeholder="Write your own question... or shuffle below">
          </div>
          
          <button class="btn btn-secondary" id="shuffleQuestion">üé≤ Random Challenge</button>
        </div>

        <!-- Challenge Preview Card -->
        <div class="challenge-card" id="challengeCard">
          <div class="challenge-label">Everyone Must Lie About...</div>
          <div class="challenge-text" id="challengeText"></div>
          <div class="challenge-actions">
            <button class="shuffle-btn" id="reshuffleBtn">‚Üª Shuffle</button>
          </div>
        </div>

        <button class="btn" id="startGameBtn" disabled>Start Game ‚Üí</button>
      </div>

      <!-- Playing Phase -->
      <div class="section" id="playingPhase">
        <div class="challenge-card visible" id="gameQuestionCard">
          <div class="challenge-label">The Question</div>
          <div class="challenge-text" id="gameQuestionText"></div>
        </div>

        <div class="card">
          <div class="progress-bar" id="progressBar"></div>
          
          <div class="record-section">
            <div class="current-player-badge">Now Playing</div>
            <div class="current-player-name" id="currentPlayerName"></div>
            
            <button class="record-btn" id="recordBtn">
              <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
              </svg>
              <svg class="stop-icon" style="display:none" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12" rx="2"/>
              </svg>
            </button>
            
            <div class="record-hint" id="recordHint">Tap to record your lie</div>
            <div class="timer" id="timer">0:00</div>
          </div>
        </div>
      </div>

      <!-- Results Phase -->
      <div class="section" id="resultsPhase">
        <div class="winner-banner" id="winnerBanner">
          <div class="winner-crown">üëë</div>
          <div class="winner-title">Best Liar</div>
          <div class="winner-name" id="winnerName"></div>
          <div class="winner-score" id="winnerScore"></div>
        </div>

        <div class="card">
          <div class="card-title">Final Scores</div>
          <div id="finalScoreboard"></div>
        </div>

        <div id="detailedBreakdown"></div>

        <button class="btn" id="playAgainBtn">üîÑ Same Question</button>
        <button class="btn btn-secondary" id="newQuestionBtn" style="margin-top:8px;">üé≤ New Question</button>
        <button class="btn btn-secondary" id="newPlayersBtn" style="margin-top:8px;">üë• New Players</button>
      </div>
    </div>

    <!-- LEADERBOARD SECTION -->
    <div class="section" id="leaderboardSection">
      <div class="card">
        <div class="card-title">All-Time Best Liars</div>
        <div id="allTimeLeaderboard">
          <p style="text-align:center;color:var(--gray-400);padding:20px;">No games played yet. Start a game to see the leaderboard!</p>
        </div>
      </div>
      
      <button class="btn btn-secondary" id="clearLeaderboardBtn" style="margin-top:8px;">üóëÔ∏è Clear Leaderboard</button>
    </div>

    <footer>
      <p class="footer-text">For entertainment only ¬∑ Audio deleted immediately</p>
    </footer>
  </div>

  <!-- Analyzing Overlay -->
  <div class="analyzing-overlay" id="analyzingOverlay">
    <div class="analyzing-spinner"></div>
    <div class="analyzing-text">Analyzing...</div>
    <div class="analyzing-subtext" id="analyzingSubtext">Detecting deception</div>
  </div>

  <script>
    // ============ QUESTIONS DATABASE ============
    const darkQuestions = [
      // Relationship chaos
      "Have you ever slept with someone's partner?",
      "Have you ever faked an orgasm?",
      "Have you ever had a one night stand you regret?",
      "Have you ever caught feelings for your friend's ex?",
      "Have you ever lied about how many people you've slept with?",
      "Have you ever hooked up with someone at work?",
      "Have you ever sent nudes you regret?",
      "Have you ever cheated on a partner?",
      "Have you ever been the other woman/man?",
      "Have you ever stayed in a relationship for the sex?",
      // Social destruction
      "Have you ever slept with someone to get ahead?",
      "Have you ever sabotaged a friend's relationship because you wanted them?",
      "Have you ever told someone's secret to hurt them?",
      "Have you ever stolen from family?",
      "Have you ever blamed your child for something you did?",
      "Have you ever pretended someone died to get out of something?",
      "Have you ever taken drugs at work?",
      "Have you ever driven blackout drunk?",
      "Have you ever been fired for something you actually did?",
      "Have you ever lied in court or to police?",
      // Dark confessions
      "Have you ever fantasized about your partner's friend?",
      "Have you ever used someone purely for money?",
      "Have you ever gotten someone fired on purpose?",
      "Have you ever ruined someone's life and didn't care?",
      "Have you ever hooked up with a friend's parent?",
      "Have you ever lied about a pregnancy or STI?",
      "Have you ever revenge-posted someone's nudes?",
      "Have you ever been attracted to a family member's partner?",
      "Have you ever stolen from a dead relative?",
      "Have you ever wished someone would die?"
    ];

    const familyQuestions = [
      // Social awkwardness
      "Have you ever pretended to remember someone's name when you had no clue?",
      "Have you ever waved back at someone who wasn't waving at you?",
      "Have you ever said 'you too' when a waiter said 'enjoy your meal'?",
      "Have you ever pulled a push door in front of people?",
      "Have you ever laughed at a joke you didn't understand?",
      "Have you ever pretended to text to avoid talking to someone?",
      "Have you ever blamed traffic when you just left late?",
      "Have you ever said 'let's definitely hang out soon' with zero intention?",
      // Work fails
      "Have you ever taken a 'bathroom break' that was really a scroll break?",
      "Have you ever unmuted yourself mid-rant on a work call?",
      "Have you ever pretended your WiFi cut out to leave a meeting?",
      "Have you ever called in sick when you were just hungover?",
      "Have you ever replied 'sounds good!' to an email you didn't read?",
      "Have you ever blamed email for something you forgot?",
      "Have you ever taken credit for someone else's idea?",
      // Adulting disasters
      "Have you ever eaten cereal for dinner three nights in a row?",
      "Have you ever rewashed the same laundry because it sat too long?",
      "Have you ever Googled something embarrassingly basic?",
      "Have you ever lied about having read a famous book?",
      "Have you ever pretended to understand wine at a restaurant?",
      "Have you ever made up an excuse to skip a wedding?",
      "Have you ever regifted something you received?",
      "Have you ever lied about working out?",
      // Relationships & dating
      "Have you ever stalked an ex on social media?",
      "Have you ever lied about liking someone's terrible cooking?",
      "Have you ever pretended to enjoy a movie to seem cool?",
      "Have you ever faked being interested in someone's hobby?",
      "Have you ever 'forgotten' to reply to a text on purpose?",
      "Have you ever pretended to be busy when you weren't?"
    ];

    // ============ STATE ============
    let contentMode = 'family';
    let players = [];
    let currentQuestion = '';
    let currentPlayerIndex = 0;
    let gameResults = [];
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let timerInterval = null;
    let recordingStartTime = null;

    // Leaderboard from localStorage
    let leaderboard = JSON.parse(localStorage.getItem('truthMachineLeaderboard') || '{}');

    // ============ ELEMENTS ============
    const playSection = document.getElementById('playSection');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const setupPhase = document.getElementById('setupPhase');
    const playingPhase = document.getElementById('playingPhase');
    const resultsPhase = document.getElementById('resultsPhase');
    const challengeCard = document.getElementById('challengeCard');
    const analyzingOverlay = document.getElementById('analyzingOverlay');

    // ============ CONTENT MODE ============
    document.querySelectorAll('.content-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.content-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        contentMode = btn.dataset.content;
        
        if (contentMode === 'dark') {
          document.body.classList.add('dark-mode');
          challengeCard.classList.remove('family-mode');
          document.getElementById('gameQuestionCard').classList.remove('family-mode');
        } else {
          document.body.classList.remove('dark-mode');
          challengeCard.classList.add('family-mode');
          document.getElementById('gameQuestionCard').classList.add('family-mode');
        }
        
        // Update challenge if visible
        if (challengeCard.classList.contains('visible')) {
          shuffleQuestion();
        }
      });
    });

    // Set initial state
    challengeCard.classList.add('family-mode');
    document.getElementById('gameQuestionCard').classList.add('family-mode');

    // ============ NAVIGATION ============
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        playSection.classList.remove('visible');
        leaderboardSection.classList.remove('visible');
        
        if (tab.dataset.tab === 'play') {
          playSection.classList.add('visible');
        } else {
          leaderboardSection.classList.add('visible');
          renderAllTimeLeaderboard();
        }
      });
    });

    // ============ PLAYER MANAGEMENT ============
    document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
    document.getElementById('playerInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') addPlayer();
    });

    function addPlayer() {
      const input = document.getElementById('playerInput');
      const name = input.value.trim();
      if (name && !players.includes(name)) {
        players.push(name);
        input.value = '';
        renderPlayers();
        checkCanStart();
      }
    }

    function removePlayer(index) {
      players.splice(index, 1);
      renderPlayers();
      checkCanStart();
    }

    function renderPlayers() {
      const container = document.getElementById('playerChips');
      container.innerHTML = players.map((p, i) => `
        <div class="player-chip">
          <span>${p}</span>
          <span class="remove" onclick="removePlayer(${i})">√ó</span>
        </div>
      `).join('');
    }

    // Make removePlayer global
    window.removePlayer = removePlayer;

    // ============ QUESTION MANAGEMENT ============
    document.getElementById('shuffleQuestion').addEventListener('click', shuffleQuestion);
    document.getElementById('reshuffleBtn').addEventListener('click', shuffleQuestion);
    document.getElementById('customQuestion').addEventListener('input', e => {
      currentQuestion = e.target.value.trim();
      if (currentQuestion) {
        document.getElementById('challengeText').textContent = currentQuestion;
        challengeCard.classList.add('visible');
      }
      checkCanStart();
    });

    function shuffleQuestion() {
      const questions = contentMode === 'family' ? familyQuestions : darkQuestions;
      currentQuestion = questions[Math.floor(Math.random() * questions.length)];
      document.getElementById('customQuestion').value = '';
      document.getElementById('challengeText').textContent = currentQuestion;
      challengeCard.classList.add('visible');
      checkCanStart();
    }

    function checkCanStart() {
      const btn = document.getElementById('startGameBtn');
      btn.disabled = !(players.length >= 2 && currentQuestion);
    }

    // ============ GAME FLOW ============
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('playAgainBtn').addEventListener('click', playAgain);
    document.getElementById('newQuestionBtn').addEventListener('click', newQuestion);
    document.getElementById('newPlayersBtn').addEventListener('click', newPlayers);

    function startGame() {
      currentPlayerIndex = 0;
      gameResults = [];
      
      setupPhase.classList.remove('visible');
      playingPhase.classList.add('visible');
      
      document.getElementById('gameQuestionText').textContent = currentQuestion;
      
      // Apply content mode to game card
      if (contentMode === 'family') {
        document.getElementById('gameQuestionCard').classList.add('family-mode');
      } else {
        document.getElementById('gameQuestionCard').classList.remove('family-mode');
      }
      
      updateProgress();
      updateCurrentPlayer();
    }

    function updateProgress() {
      const container = document.getElementById('progressBar');
      container.innerHTML = players.map((_, i) => {
        let cls = 'progress-dot';
        if (i < currentPlayerIndex) cls += ' done';
        else if (i === currentPlayerIndex) cls += ' current';
        return `<div class="${cls}"></div>`;
      }).join('');
    }

    function updateCurrentPlayer() {
      document.getElementById('currentPlayerName').textContent = players[currentPlayerIndex];
      document.getElementById('recordHint').textContent = 'Tap to record your lie';
      document.getElementById('timer').classList.remove('visible');
      document.getElementById('timer').textContent = '0:00';
    }

    function playAgain() {
      resultsPhase.classList.remove('visible');
      playingPhase.classList.add('visible');
      currentPlayerIndex = 0;
      gameResults = [];
      updateProgress();
      updateCurrentPlayer();
    }

    function newQuestion() {
      resultsPhase.classList.remove('visible');
      setupPhase.classList.add('visible');
      currentQuestion = '';
      document.getElementById('customQuestion').value = '';
      challengeCard.classList.remove('visible');
      checkCanStart();
      // Players are kept!
    }

    function newPlayers() {
      resultsPhase.classList.remove('visible');
      setupPhase.classList.add('visible');
      players = [];
      currentQuestion = '';
      renderPlayers();
      document.getElementById('customQuestion').value = '';
      challengeCard.classList.remove('visible');
      checkCanStart();
    }

    // ============ RECORDING ============
    const recordBtn = document.getElementById('recordBtn');
    
    recordBtn.addEventListener('click', async () => {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    });

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          stream.getTracks().forEach(track => track.stop());
          await analyzeResponse(audioBlob);
        };
        
        mediaRecorder.start();
        isRecording = true;
        
        recordBtn.classList.add('recording');
        recordBtn.querySelector('.mic-icon').style.display = 'none';
        recordBtn.querySelector('.stop-icon').style.display = 'block';
        document.getElementById('recordHint').textContent = 'Recording...';
        document.getElementById('recordHint').classList.add('recording');
        
        recordingStartTime = Date.now();
        document.getElementById('timer').classList.add('visible');
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          document.getElementById('timer').textContent = 
            `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
        }, 100);
        
      } catch (err) {
        alert('Microphone access required.');
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        recordBtn.classList.remove('recording');
        recordBtn.querySelector('.mic-icon').style.display = 'block';
        recordBtn.querySelector('.stop-icon').style.display = 'none';
        document.getElementById('recordHint').textContent = 'Processing...';
        document.getElementById('recordHint').classList.remove('recording');
        
        clearInterval(timerInterval);
      }
    }

    async function analyzeResponse(audioBlob) {
      showAnalyzing();
      
      const formData = new FormData();
      formData.append('audio', audioBlob, 'recording.webm');
      formData.append('mode', 'party');
      formData.append('prompt', currentQuestion);
      
      try {
        const res = await fetch('/api/analyze', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        hideAnalyzing();
        
        if (data.success) {
          let score = data.totalScore || 50;
          
          gameResults.push({
            player: players[currentPlayerIndex],
            score: parseFloat(score.toFixed(1)),
            scores: data.scores || null,
            verdict: data.verdict,
            confidence: data.confidence,
            transcript: data.transcript,
            breakdown: data.breakdown || '',
            tip: data.tip || ''
          });
          
          currentPlayerIndex++;
          
          if (currentPlayerIndex < players.length) {
            updateProgress();
            updateCurrentPlayer();
          } else {
            showResults();
          }
        }
      } catch (err) {
        hideAnalyzing();
        alert('Analysis failed: ' + err.message);
      }
    }

    // ============ RESULTS ============
    function showResults() {
      playingPhase.classList.remove('visible');
      resultsPhase.classList.add('visible');
      
      // Sort by score
      gameResults.sort((a, b) => b.score - a.score);
      
      // Winner banner
      const winner = gameResults[0];
      document.getElementById('winnerName').textContent = winner.player;
      document.getElementById('winnerScore').textContent = `${winner.score.toFixed(1)}/100 points`;
      
      // Update all-time leaderboard
      gameResults.forEach(r => {
        if (!leaderboard[r.player]) {
          leaderboard[r.player] = { games: 0, totalScore: 0, wins: 0, bestScore: 0 };
        }
        leaderboard[r.player].games++;
        leaderboard[r.player].totalScore += r.score;
        if (r === winner) leaderboard[r.player].wins++;
        if (r.score > leaderboard[r.player].bestScore) {
          leaderboard[r.player].bestScore = r.score;
        }
      });
      localStorage.setItem('truthMachineLeaderboard', JSON.stringify(leaderboard));
      
      // Scoreboard
      const scoreboard = document.getElementById('finalScoreboard');
      scoreboard.innerHTML = gameResults.map((r, i) => {
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
          <div class="leaderboard-item">
            <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
            <div class="leaderboard-info">
              <div class="leaderboard-name">${r.player}</div>
              <div class="leaderboard-stats">AI verdict: ${r.verdict} (${r.confidence}%)</div>
            </div>
            <div class="leaderboard-score">${r.score.toFixed(1)}</div>
          </div>
        `;
      }).join('');
      
      // Detailed breakdown
      const breakdown = document.getElementById('detailedBreakdown');
      const scoreLabels = {
        deception: 'üé≠',
        conviction: 'üí™',
        creativity: '‚ú®',
        detail: 'üìù',
        entertainment: 'üé™'
      };
      
      const scoreTooltips = {
        deception: 'Poker Face - Did they sell it convincingly?',
        conviction: 'Confidence - Did they believe their own lie?',
        creativity: 'Creativity - Original and imaginative story?',
        detail: 'Detail - Specific names, places, facts?',
        entertainment: 'Showmanship - Funny, dramatic, engaging?'
      };
      
      breakdown.innerHTML = '<div class="card"><div class="card-title">Detailed Breakdown</div>' +
        gameResults.map((r, i) => `
          <div class="score-card">
            <div class="score-card-header">
              <span class="score-card-name">${i === 0 ? 'üëë ' : ''}${r.player}</span>
              <span class="score-card-total">${r.score.toFixed(1)}</span>
            </div>
            ${r.scores ? `
              <div class="score-grid">
                ${Object.entries(r.scores).map(([key, val]) => `
                  <div class="score-item" title="${scoreTooltips[key] || key}">
                    <div class="score-item-label">${scoreLabels[key] || key}</div>
                    <div class="score-item-value">${typeof val === 'number' ? val.toFixed(1) : val}</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            ${r.breakdown ? `<div class="score-feedback">${r.breakdown}</div>` : ''}
            ${r.tip ? `<div class="score-tip">üí° ${r.tip}</div>` : ''}
          </div>
        `).join('') + '</div>';
    }

    // ============ ALL-TIME LEADERBOARD ============
    function renderAllTimeLeaderboard() {
      const container = document.getElementById('allTimeLeaderboard');
      
      const sorted = Object.entries(leaderboard)
        .map(([name, stats]) => ({
          name,
          avgScore: stats.totalScore / stats.games,
          ...stats
        }))
        .sort((a, b) => b.avgScore - a.avgScore);
      
      if (sorted.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--gray-400);padding:20px;">No games played yet!</p>';
        return;
      }
      
      container.innerHTML = sorted.map((p, i) => {
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
          <div class="leaderboard-item">
            <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
            <div class="leaderboard-info">
              <div class="leaderboard-name">${p.name}</div>
              <div class="leaderboard-stats">${p.games} games ¬∑ ${p.wins} wins ¬∑ Best: ${p.bestScore.toFixed(1)}</div>
            </div>
            <div class="leaderboard-score">${p.avgScore.toFixed(1)}</div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('clearLeaderboardBtn').addEventListener('click', () => {
      if (confirm('Clear all leaderboard data?')) {
        leaderboard = {};
        localStorage.removeItem('truthMachineLeaderboard');
        renderAllTimeLeaderboard();
      }
    });

    // ============ OVERLAY ============
    function showAnalyzing() {
      analyzingOverlay.classList.add('visible');
      const messages = ['Detecting deception', 'Reading your soul', 'Scanning for tells', 'Judging silently'];
      let idx = 0;
      const interval = setInterval(() => {
        idx = (idx + 1) % messages.length;
        document.getElementById('analyzingSubtext').textContent = messages[idx];
      }, 1000);
      analyzingOverlay.dataset.interval = interval;
    }

    function hideAnalyzing() {
      analyzingOverlay.classList.remove('visible');
      clearInterval(analyzingOverlay.dataset.interval);
    }

    // Health check
    fetch('/api/health').then(r => r.json()).then(console.log).catch(console.error);
  </script>

  <!-- DevHub Analytics -->
  <script src="https://devhub-production-7ecc.up.railway.app/devhub-sdk.js"></script>
  <script>
    DevHub.init({
      apiKey: 'devhub-portfolio',
      appId: 'liar-liar',
      endpoint: 'https://devhub-production-7ecc.up.railway.app/api'
    });
  </script>
</body>
</html>
